image: continuumio/miniconda3

stages:
  - lint
  - test
  - build
  - deploy

# -------------------- LINTING --------------------
lint:
  stage: lint
  script:
    - apt update && apt install -y gcc
    - conda install python=3.9 psutil
    - pip install "pydocstyle<4" flake8 pep8-naming flake8-docstrings
    - flake8 --config=.flake8 scared tests setup.py

# -------------------- TEST JOBS --------------------

.test:python:
  stage: test
  script:
    - apt update && apt install -y gcc
    - eval "$(conda shell.bash hook)"
    - conda create -n env-python$PYTHON_VERSION python=$PYTHON_VERSION
    - conda activate env-python$PYTHON_VERSION
    - if [[ -n "$NUMPY_VERSION" ]]; then conda install numpy=$NUMPY_VERSION; fi
    - pip install .[test]
    - pytest --color=yes -vv --cov=scared tests
  variables:
    PYTHON_VERSION: "3.10"
    NUMPY_VERSION: ""

test:python39:
  extends: .test:python
  variables:
    PYTHON_VERSION: "3.9"

test:python310-intel:
  extends: .test:python
  variables:
    PYTHON_VERSION: "3.10"
    NUMPY_VERSION: "1.26.4"

test:python310:
  extends: .test:python
  variables:
    PYTHON_VERSION: "3.10"

test:python311:
  extends: .test:python
  variables:
    PYTHON_VERSION: "3.11"

test:python312:
  extends: .test:python
  variables:
    PYTHON_VERSION: "3.12"

# -------------------- BUILD JOBS --------------------

.build:conda:
  stage: build
  script:
    - export CONDA_SUBDIR=$ARCHITECTURE
    - cd .recipe
    - conda install conda-build conda-verify
    - conda config --add channels $ANACONDA_CHANNEL
    - if [[ "$ARCHITECTURE" == "linux-aarch64" ]]; then apt update && apt install -y qemu-user-static; fi  # Enable ARM emulation
    - conda build --output-folder out prod
    - conda clean --all -y
  artifacts:
    paths:
      - ".recipe/out/*/*.tar.bz2"
  variables:
    ARCHITECTURE: "linux-64"
  only:
    - tags

build:conda:x86_64:
  extends: .build:conda
  variables:
    ARCHITECTURE: "linux-64"

build:conda:arm64:
  extends: .build:conda
  variables:
    ARCHITECTURE: "linux-aarch64"

# -------------------- DEPLOY JOBS --------------------

.deploy:pypi:
  stage: deploy
  script:
    - pip install -U pip setuptools twine
    - twine upload --repository-url $PYPI_REPOSITORY dist/*.tar.gz -u $PYPI_USERNAME -p $PYPI_PWD
    - twine upload --repository-url $PYPI_REPOSITORY dist/*.whl -u $PYPI_USERNAME -p $PYPI_PWD
  only:
    - tags
  when: manual

.deploy:conda:
  stage: deploy
  script:
    - cd .recipe
    - conda config --add channels $ANACONDA_CHANNEL
    - conda update conda
    - conda install anaconda-client
    - anaconda -t $ANACONDA_TOKEN upload out/*/scared*.tar.bz2
  only:
    - tags
  when: manual
  artifacts:
    paths:
      - ".recipe/out/*/*.tar.bz2"

# -------------------- DOCUMENTATION --------------------

pages:
  stage: build
  script:
    - conda install python=3.9 psutil
    - conda install -c conda-forge myst-parser
    - pip install -e .
    - cd docs
    - ./build_doc.sh
  artifacts:
    paths:
      - public
  only:
    - tags
